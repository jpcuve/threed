<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<script src="js/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/AssetLoader.js"></script>
<script src="js/Keyboard.js"></script>
<script>

    var debug = 1;

    THREE.Vector3.prototype.rotz44 = function(r){
        "use strict";
        var x = this.x, y = this.y, z = this.z;
        switch(r % 4){
            case 1:
                this.set(7 - y, x, z);
                break;
            case 2:
                this.set(7 - x, 7 - y, z);
                break;
            case 3:
                this.set(y, 7 - x, z);
                break;
        }
    };

    THREE.Vector3.prototype.add8 = function(vector3){
        var x = this.x, y = this.y, z = this.z;
        this.set((x + vector3.x) % 8, (y + vector3.y) % 8, (z + vector3.z) % 8);
    };

    function Player(brushData, screenData){
        "use strict";
        this.brushes = {};
        this.screens = {};
        this.layouts = ['basic', 'extruded', 'basic', 'column', 'special'];
        this.floor = new Uint8Array(4).fill(0);
        var brushCount = 0, screenCount = 0, offset, l, i, j;
        offset = 0;
        while (offset < brushData.length){
            l = brushData[offset + 1];
            this.brushes[brushData[offset]] = brushData.slice(offset, offset + l);
            offset += l;
            brushCount++;
        }
        if (debug){
            console.log('brush count:', brushCount);
        }
        offset = 0;
        while (offset < screenData.length){
            l = screenData[offset];
            j = screenData[offset + 1];
            i = screenData[offset + 2];
            if ((i & 0x80) !== 0){
                i -= 0x80;
                this.start = new THREE.Vector2(i, j);
            }
            this.screens[(j << 8) + i] = screenData.slice(offset, offset + l);
            offset += l;
            screenCount++;
        }
        if (debug){
            console.log('screen count:', screenCount);
        }
    }

    Player.prototype.terrain = function(paint, po, ro, buffer, offset, level){
        "use strict";
        var l, p, r, nature, type;
        while ((l = buffer[offset] + (buffer[offset + 1] << 8)) != 0){
            p = new THREE.Vector3(l >> 10 & 7, l >> 13 & 7, l >> 7 & 7);
            var f = l & 0x7F, m = f >> 5, t = f >> 2 & 7;
            if ((f & 0x1F) === 2) { // brush
                var index = buffer[offset + 2], brush = this.brushes[index];
                r = (l >> 5) & 3;
                if (debug){
                    console.log('local brush: (', p.x, ',', p.y, ',', p.z, ')r:' , r);
                }
                p.add8(po);
//                p.rotz44(ro); // apply rotation
                if (debug){
                    console.log(level + 1, '> brush:', index);
                }
                this.terrain(paint, p, ro + r, brush, 2, level + 1);
                if (debug){
                    console.log(level + 1, '> end brush:', index);
                }
                offset++;
            } else {
                r = 0;
                nature = 'undefined';
                type = 0;
                switch(f){
                    case 1:
                    case 0x21:
                    case 0x61:
                        nature = 'block';
                        break;
                    case 3:
                    case 0x23:
                    case 0x63:
                        nature = 'trampoline';
                        break;
                    case 0x40:
                        nature = 'water';
                        break;
                    case 0x43:
                        nature = 'ice';
                        break;
                    default:
                        if ((f & 0x70) === 0x50){
                            nature = 'clue';
                            type = f & 0xF;
                        } else if ((f & 0x7C) === 0x44){
                            nature = 'arrow';
                            r = f & 3;
                        } else {
                            nature = 'slope';
                            type = t;
                            r = f & 3;
                        }
                        break;
                }
                if (debug){
                    console.log('local block: (', p.x, ',', p.y, ',', p.z, ')r:' , r);
                }
                p.add8(po);
                p.rotz44(ro); // apply rotation
                paint(this.layouts[m], p, ro + r, nature, type);
            }
            offset += 2;
        }
        return offset + 2;
    };

    Player.prototype.special = function(paint, po, ro, buffer, offset){
        "use strict";
        var l, p, nature;
        while (buffer[offset] != 0){
            l = buffer[offset] + (buffer[offset + 1] << 8) + (buffer[offset + 2] << 16);
            p = new THREE.Vector3(l >> 10 & 7, l >> 13 & 7, l >> 7 & 7);
            nature = 'undefined';
            if ((l & 0x7F) === 1){
                nature = 'jewel';
            } else if ((l & 0x7) === 2){
                nature = 'lift';
            } else if ((l & 0x77) === 3){
                nature = 'enemy';
            } else if ((l & 4) === 4){
                nature = 'puzzle';
            }
            paint(this.layouts[4], new THREE.Vector3().addVectors(po, p), ro, nature, l);
            offset += 3;
        }
        return offset;
    };

    Player.prototype.screen = function(paint, p, ro){
        "use strict";
        var screen = this.screens[(p.y << 8) + p.x], offset, x, y;
        if (screen) {
            if (debug){
                console.log('0 > screen:', p.x, p.y);
            }
            this.floor[0] = screen[4];
            for (x = screen[5] >> 2 & 7; x < 8; x++){
                for (y = screen[5] >> 5 & 7; y < 8; y++){
                    this.floor[1] = (y << 5) + (x << 2) + (screen[5] & 3);
                    this.terrain(paint, new THREE.Vector3(), 0, this.floor, 0, 0);
                }
            }
            offset = this.terrain(paint, new THREE.Vector3(), ro, screen, 6, 0);
            offset = this.special(paint, new THREE.Vector3(), 0, screen, offset);
            if (debug){
                console.log('0 > end screen:', p.x, p.y);
            }
            return offset;
        }
        return 0;
    };

    Player.prototype.dump = function(){
        "use strict";
        var x, y, ar;
        for (y = 40; y < 80; y++){
            if (y % 10 == 0){
                console.log("-");
            }
            ar = [];
            for (x = 40; x < 90; x++) {
                if (x % 10 == 0) {
                    ar.push(" ");
                }
                if (this.screen(paint, x, y)) {
                    ar.push("*");
                } else {
                    ar.push(".");
                }
            }
            console.log(ar.join(""));
        }
    };


    var keyboard = new Keyboard();
    var scene = new THREE.Scene();
    var plane = new THREE.Mesh(new THREE.PlaneBufferGeometry(8, 8, 8, 8), new THREE.MeshBasicMaterial({ wireframe: false, color: 'lightgray', transparent: true, opacity: 0.8 }));
//    scene.add(plane);

    function paint(layout, p, r, nature, type){
        "use strict";
        console.log('*', layout,'(', p.x, ',', p.y, ',', p.z, ')r:', r, nature, type);
        var boxGeometry = new THREE.BoxGeometry(1, 1, 0.5);
        switch(layout){
            case 'column':
                    [0, 2, 7, 5].forEach(function(vertex){
                        boxGeometry.vertices[vertex].setZ(-0.25 + 0.5 * (p.z + 1));
                    });
                p.setZ(0);
                break;
        }
        var color = 'white';
        switch(nature){
            case 'slope':
                [7, 2].forEach(function(vertex){
                    boxGeometry.vertices[vertex].setZ(boxGeometry.vertices[vertex].z + (0.5 * type));
                });
                break;
            case 'arrow':
                color = 'green';
                break;
            case 'trampoline':
                color = 'red';
                break;
            case 'water':
                color = 'blue';
                [1, 3, 6, 4].forEach(function(vertex){
                    boxGeometry.vertices[vertex].setZ(+0.25);
                });
                break;
        }
        var boxMaterial = new THREE.MeshBasicMaterial({wireframe: true, color: color});
        var boxMesh = new THREE.Mesh(boxGeometry, boxMaterial);
        boxMesh.translateX(p.x - 3.5);
        boxMesh.translateY(p.y - 3.5);
        boxMesh.translateZ(p.z / 2);
        boxMesh.rotateZ((r % 4) * Math.PI / 2);
        scene.add(boxMesh);
    }

    var i = 62, j = 64;
    var assetLoader = new AssetLoader(function(assets) {
        "use strict";
        var player = new Player(assets['brushes'].asset, assets['screens'].asset);
//        player.screen(paint, player.start);
        player.screen(paint, new THREE.Vector2(i, j), 0); // 62,64: complex
        animate();
    });
    assetLoader.add('brushes', 'binary', 'assets/models/spindizzy_brushes.bin');
    assetLoader.add('screens', 'binary', 'assets/models/spindizzy_screens.bin');
    assetLoader.load();


    var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    var orbitControls = new THREE.OrbitControls(camera);

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    var geometry = new THREE.BoxGeometry(1, 1, 1);
    var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
    var cube = new THREE.Mesh(geometry, material);
//    scene.add(cube);

    camera.position.z = 10;

    var animate = function (){
        "use strict";
        orbitControls.update();
        requestAnimationFrame(animate);
        cube.rotation.x += 0.1;
        cube.rotation.y += 0.1;
        renderer.render(scene, camera);
    };

</script>



</body>
</html>